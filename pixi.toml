[workspace]
channels = ["conda-forge"]
name = "FANS"
platforms = ["linux-64", "linux-ppc64le", "linux-aarch64", "osx-arm64", "osx-64"]
preview = ["pixi-build"]

[dependencies]
fans = { path = "." }

[feature.dashboard.dependencies]
python = ">=3.13.5,<3.14"
pytest = ">=8.4.1,<9"
pre-commit = ">=4.2.0,<5"
sympy = ">=1.14.0,<2"
quaternion = ">=2024.0.8,<2025"
beartype = ">=0.21.0,<0.22"
ipykernel = ">=6.29.5,<7"
time = ">=1.9,<2"

[feature.dashboard.pypi-dependencies]
fans-dashboard = { path = "FANS_Dashboard", editable = true }
MSUtils = {git = "https://github.com/DataAnalyticsEngineering/MSUtils.git"}
pyrecest = {git = "https://github.com/FlorianPfaff/pyRecEst.git"}

[feature.dashboard.tasks]
pytest = "pytest -v -s"
precommit = "pre-commit run --all-files"

[feature.dashboard.tasks.h52xdmf]
args = ["file", { arg = "extra", default = "" }]
cmd  = "cd \"$INIT_CWD\" && python -m MSUtils.general.h52xdmf {{ extra }} {{ file }}"

[feature.dev.dependencies]
cmake = "*"
openmpi-mpicxx = "*"
hdf5 = { version = "*", build = "mpi_openmpi_*" }
fftw = { version = "*", build = "mpi_openmpi_*" }
eigen = "*"
nlohmann_json = "*"
time = "*"

[tasks]
test = { cmd = "pytest -v -s --from-pixi", cwd = "test/pytest", depends-on = ["test-fans"] }
test-fans = { cmd = "./run_tests.sh -n {{n}}", args = [
  { arg = "n", default = "2" }, # Number of threads
], cwd = "test" }

[environments]
default   = { features = ["dashboard"]}
dashboard = { features = ["dashboard"], no-default-feature = true }
dev       = { features = ["dev"],       no-default-feature = true }

################## Pixi build part ##################

[package]
name = "fans"
version = "0.4.2"

[package.build]
backend = { name = "pixi-build-cmake", version = "*" }

[package.build.config]
extra-args = [
    "-DFANS_LIBRARY_FOR_MICRO_MANAGER=ON",
    ]

[workspace.target.osx-arm64.build-variants]

[workspace.target.linux-64.build-variants]
cxx_compiler = ["clangxx"]

[package.build-dependencies]
cmake = "*"
pybind11 = "*"
pkg-config = "*"
ninja = "*"

[package.host-dependencies]
hdf5 = { version = "*", build = "* mpi_openmpi*" }
fftw = { version = "*", build = "* mpi_openmpi*" }
openmpi-mpicxx = "*"
eigen = "*"
nlohmann_json = "*"
